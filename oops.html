<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
  <meta charset="utf-8" />
  <title>Oops, I Did It Again: Automatically Encrypting Secrets</title>
  <meta name="description" content="Let's automate the encryption of secrets, even for publicly stored remote git repositories." />
  <meta name="keywords" content="encryption, secrets, programming, bash, pre-commit" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
  <meta property="og:title" content="Oops, I Did It Again: Automatically Encrypting Secrets" />
  <meta property="og:url" content="http://127.0.0.1:8000/oops" />
  <meta property="og:description" content="Let's automate the encryption of secrets, even for publicly stored remote git repositories." />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Zev Averbach" />
  <meta name="color-scheme" content="dark light">
  <meta property="og:locale" content="en_US" />
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="/static/prism-dark.css?v=0" />
  <link rel="stylesheet" href="/static/style.css?v=0" />
  <meta name="theme-color" content="#209cee" />
  <link rel="canonical" href="http://127.0.0.1:8000/oops" />
  
</head> <body>
  <nav>
  <div id="logo">
    <a href="http://[::]:8000/"
      class="logo-thin">
      Zev Averbach
    </a>
    
    <h1 class="title" style="color: #734f96">
      Oops, I Did It Again: Automatically Encrypting Secrets</h1>
    
  </div>
</nav>
  <div id="body">
    <p>Got a heads-up from OpenAI that they'd invalidated my token because I'd
exposed it publicly! Oops. This isn't the first time I've done it, but
this will be the first time I take a computational approach towards
avoiding it.</p>
<p>(tl;dr use the code and brief instructions in <a style='color: #734f96' href="https://gist.github.com/zevaverbach/85745043a417fcef2feb018deaac0cd9">this
gist</a>.)</p>
<h2 style='color: #734f96'>First: Damage Control</h2>
<p>I shared three secret tokens actually, about 24 hours ago when I pushed
an update of my <code>.bashrc</code> to a public repo. This repo was there for a
long time, but I guess I'd been careful about pushing anything sensitive
to it: Specifically, I've been using this code block to separate sensitive
environment variables out from others:</p>
<pre><code class="language-bash">if [ -f ~/.bash_private ]; then
    . ~/.bash_private
fi
</code></pre>
<p>But I guess I mistakenly moved towards keeping everything in a single
&quot;run control&quot; (.bash<em>rc</em>) file.</p>
<p>To their credit, OpenAI alerted me before anyone else, and in fact Netlify
and GitHub hadn't detected it after the first 24 hours. Not that it's their
job! But kudos in any case to OpenAI.</p>
<p>I removed all the tokens from the other two providers, and made the
<code>.bashrc</code> repo private for now.</p>
<h2 style='color: #734f96'>Next: Encryption</h2>
<p>I'd first heard of keeping secrets in public repos by encrypting them in
<a style='color: #734f96' href="https://frontendmasters.com/courses/developer-productivity/store-ssh-auth-keys-with-ansible-vault/">this
section</a>
of ThePrimeagen's &quot;Developer Productivity&quot; course, but I clearly haven't
put that into action. The command he uses for encrypting or decrypting
is</p>
<pre><code class="language-bash">$ ansible-vault &lt;encrypt/decrypt&gt; &lt;filename&gt;
</code></pre>
<p>after having <a style='color: #734f96' href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html">installed ansible</a>. Easy enough! As a bonus, the
algorithm it uses is <a style='color: #734f96' href="https://en.wikipedia.org/wiki/Post-quantum_cryptography#Symmetric_key_quantum_resistance">probably quantum-safe</a>. ðŸ¤–</p>
<p>There are several other viable options for two-way encryption of
secrets, Mozilla's SOPS being one, FYI.</p>
<h2 style='color: #734f96'>Alerts For Unencrypted Secret Files</h2>
<p>Now, how to abort and alert when committing code which contains
unencrypted secrets? <a style='color: #734f96' href="https://devops.stackexchange.com/questions/16317/how-to-ansible-vault-files-as-they-are-commited-to-git?newreg=a7e3811180a7401ea428511549dd5a09">This DevOps StackExchange question</a> seems
to be a good start. Let's see if I can get a <code>pre-commit</code> hook to
do this for my <code>.bashrc</code> file:</p>
<pre><code class="language-bash">#!/bin/sh
#
# Put this file in .git/hooks/pre-commit
# from https://devops.stackexchange.com/questions/16317/how-to-ansible-vault-files-as-they-are-committed-to-git?newreg=a7e3811180a7401ea428511549dd5a09

set -o nounset

FILE_PATTERN=&quot;.bashrc|.env&quot;   # ðŸ‘ˆ I've also included a pattern for .env files
ENCRYPTED_PATTERN=&quot;$ANSIBLE_VAULT&quot;

is_encrypted() {
  local file=$1
  if ! git show :&quot;$file&quot; | grep --quiet &quot;^${ENCRYPTED_PATTERN}&quot;; then
    echo &quot;Located a staged file that should be encrypted:
&gt; ${file}
&quot;
    echo &quot;Please un-stage this file. If you are adding or updating this file, please encrypt it before staging.&quot;
    echo &quot;Alternatively, you can git checkout the latest encrypted version of the file before committing.
&quot;
    echo &quot;Remember... Only YOU Can Prevent Secret Leakage.&quot;
    exit 1
  fi
}

echo &quot;Running pre-commit checks...&quot;
git diff --cached --name-only | grep &quot;${FILE_PATTERN}&quot; | while IFS= read -r line; do
  is_encrypted &quot;${line}&quot;
done
</code></pre>
<p>If I pop that in the repo where <code>.bashrc</code> is and try to commit it
without encrypting it first, it stops me and displays:</p>
<pre><code class="language-bash">Running pre-commit checks...
Located a staged file that should be encrypted:
&gt; .bashrc

Please un-stage this file. If you are adding or updating this file, please encrypt it before staging.
Alternatively, you can git checkout the latest encrypted version of the file before committing.

Remember... Only YOU Can Prevent Secret Leakage.
</code></pre>
<p>That's pretty awesome! Let's make it a little more foolproof by making
this pre-commit run for <em>all</em> commits to local repos:</p>
<pre><code class="language-bash">$ mkdir ~/.githooks
$ git config --global core.hooksPath ~/.githooks
$ mv .git/hooks/pre-commit ~/.githooks
$ chmod +x ~/.githooks/pre-commit
</code></pre>
<h2 style='color: #734f96'>Automatically Encrypt Files On Commit</h2>
<p>How to automate the encryption of these secret files, though? There's no
such automation in <a style='color: #734f96' href="https://devops.stackexchange.com/a/16333/40029">the StackExchange
answer</a>, but there is a
bash script provided to encrypt or decrypt manually. What's more,
there's an improved version of that script in <a style='color: #734f96' href="https://warlord0blog.wordpress.com/2022/12/05/git-hooks/">this blog
post</a>, the
improvement being that it skips any already encrypted files which match
the <code>FILE_PATTERN</code> instead of breaking out of the <code>while</code> loop.</p>
<p>Let's incorporate the relevant logic into our globally installed
pre-commit hook:</p>
<pre><code class="language-bash">#!/bin/sh
# ~/.githooks/pre-commit

set -o nounset

FILE_PATTERN=&quot;.bashrc|.env&quot;
ENCRYPTED_PATTERN=&quot;$ANSIBLE_VAULT&quot;

encrypt_if_needed_then_add() {
  local file=$1
  if ! git show :&quot;$file&quot; | grep --quiet &quot;^${ENCRYPTED_PATTERN}&quot;; then
    echo &quot;Located a staged file that should be encrypted:
&gt; ${file}
&quot;
    encrypt $file
    git add $file
  fi
}

encrypt() {
  local file=$1
  echo &quot;$file&quot;;
  password_type=--ask-vault-password
  if [ -f &quot;$HOME/.vault_password&quot; ]
  then
      password_type=&quot;--vault-password-file $HOME/.vault_password&quot;
  fi
  ansible-vault encrypt $password_type $file
}

echo &quot;Running pre-commit checks...&quot;
git diff --cached --name-only | grep &quot;${FILE_PATTERN}&quot; | while IFS= read -r line; do
  encrypt_if_needed_then_add &quot;${line}&quot;
done
</code></pre>
<p>I've also put the vault password in a new file <code>~/.vault_password</code> so I
don't have to enter it for every <code>ansible-vault</code> command. This works
beautifully on commit, and won't try to encrypt files which are already
encrypted:</p>
<pre><code class="language-bash">$ ls -a
.        ..        .bashrc    .env        .git        .gitignore

$ cat .env  # ðŸ‘ˆ let's say this one is already encrypted
$ANSIBLE_VAULT;1.1;AES256
30643665626462663736373366386138313966616234313939626563333833363439396530366633
3763383837393934323861313138646137316362333231380a623530396135326536353062333534
34333133383734623161636135616165653833306463336161353032376263316531666339666639
3863663839323835370a333738303064623230653164616531343438386166353461613962626631
3964

$ cat .bashrc  # ðŸ‘ˆ and this one isn't
export OPENAI_KEY=&quot;sk-hithisisntreallymykey0Kivelearnedmylesson&quot;

$ git add --all &amp;&amp; git commit -m &quot;first&quot;
Running pre-commit checks...
Located a staged file that should be encrypted:
&gt; .bashrc

.bashrc
Encryption successful
</code></pre>
<h2 style='color: #734f96'>Automatically Decrypt Files After Commit</h2>
<p>The pre-commit hook will work for making sure the secrets are encrypted,
but I actually want to immediately decrypt those secrets once the commit
is completed, so I can use them locally, modify them, etc. If I copy
<code>pre-commit</code> to a file <code>post-commit</code> and make these changes, this should
accomplish it:</p>
<pre><code class="language-bash">#!/bin/sh
# ~/.githooks/post-commit

set -o nounset

FILE_PATTERN=&quot;.bashrc|.env&quot;
ENCRYPTED_PATTERN=&quot;$ANSIBLE_VAULT&quot;

decrypt_if_needed() {
  local file=$1
  if git show :&quot;$file&quot; | grep --quiet &quot;^${ENCRYPTED_PATTERN}&quot;; then
    echo &quot;Located a committed file that should be decrypted:
&gt; ${file}
&quot;
    decrypt $file
  fi
}

decrypt() {
  local file=$1
  echo &quot;$file&quot;;
  password_type=--ask-vault-password
  if [ -f &quot;$HOME/.vault_password&quot; ]
  then
      password_type=&quot;--vault-password-file $HOME/.vault_password&quot;
  fi
  ansible-vault decrypt $password_type $file
}

echo &quot;Running post-commit checks...&quot;
files=$(ls -a | grep &quot;${FILE_PATTERN}&quot;)
for file in $files; do
  echo $file
  decrypt_if_needed $file
done
</code></pre>
<p>Now, when <code>.bashrc</code> is unencrypted, this is what happens on commit:</p>
<pre><code class="language-bash">$ git add --all &amp;&amp; git commit -m &quot;first&quot;
Running pre-commit checks...
Located a staged file that should be encrypted:
&gt; .bashrc

.bashrc
Encryption successful

Running post-commit checks...
.bashrc
Located a committed file that should be decrypted:
&gt; .bashrc

.bashrc
Decryption successful
[trunk 0798892] first

$ git status
On branch trunk
Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git restore &lt;file&gt;...&quot; to discard changes in working directory)
    modified:   .bashrc

no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)

$ cat .bashrc
export OPENAI_KEY=&quot;sk-hithisisntreallymykey0Kivelearnedmylesson&quot;
</code></pre>
<p>The secret file is unencrypted and there's an unstaged change to it.
This is as expected, since the post-commit hook decrypted it. Not a 100%
perfect solution since I'll constantly have unstaged changes showing for
my secret files, but I'm willing to live with it.</p>
<h2 style='color: #734f96'>What About Post-Checkout and Post-Pull?</h2>
<p>One flaw I can't live with is that if I check out a different branch or
commit of this repo, the secrets-containing files will be encrypted.
This will also happen when pulling from a remote repo.</p>
<p>I'm <em>pretty sure</em> the quick solution for this is:</p>
<pre><code class="language-bash">$ cp ~/.githooks/post-commit ~/.githooks/post-checkout
$ cp ~/.githooks/post-commit ~/.githooks/post-merge
</code></pre>
<p>It works perfectly for checkout, but I haven't tested it for pull/merge
yet.</p>
<h2 style='color: #734f96'>The End</h2>
<p>I think this will suffice for automatically encrypting secrets on
commit. The biggest point of failure is <code>FILE_PATTERN</code>, which I'll have
to be mindful of and modify as needed.</p>
 <a id="up-button"
    style="transform: rotate(-90deg); position: fixed; width: calc(1.8em + 1.5vw); height: calc(1.8em + 1.5vw); right: 15vw; bottom: 5vw; cursor: pointer;"
    onclick="handleUpButtonClick()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#734f96" class="w-6 h-6">
        <path fill-rule="evenodd"
            d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm.53 5.47a.75.75 0 00-1.06 0l-3 3a.75.75 0 101.06 1.06l1.72-1.72v5.69a.75.75 0 001.5 0v-5.69l1.72 1.72a.75.75 0 101.06-1.06l-3-3z"
            clip-rule="evenodd" />
    </svg>
</a> <div id="about">
  
  <a style="grid-row: span 6;" href="/"><img id='portrait' src="https://www.gravatar.com/avatar/fe783e04644862c30823614f31b9a996/?s=360"
      alt="smiley picture of shaven-head Zev"></a>
  <p style="grid-row: span 3; font-weight: 600;" id="about-name">Zev Averbach</p>
  <p>Excitable software engineer. Constant builder, learner, and teacher. ðŸŒ¼</p>
  
  <div id="links">
    <a style="color: #734f96" href="static/resume.pdf">
        <svg style="fill: #734f96" class="about-icon" width="24" height="24" xmlns="http://www.w3.org/2000/svg"
            fill-rule="evenodd" clip-rule="evenodd">
            <title>RÃ©sumÃ©</title>
            <path class="about-icon-fill"
                d="M3 24h19v-23h-1v22h-18v1zm17-24h-18v22h18v-22zm-1 1h-16v20h16v-20zm-2 16h-12v1h12v-1zm0-3h-12v1h12v-1zm0-3h-12v1h12v-1zm-7.348-3.863l.948.3c-.145.529-.387.922-.725 1.178-.338.257-.767.385-1.287.385-.643 0-1.171-.22-1.585-.659-.414-.439-.621-1.04-.621-1.802 0-.806.208-1.432.624-1.878.416-.446.963-.669 1.642-.669.592 0 1.073.175 1.443.525.221.207.386.505.496.892l-.968.231c-.057-.251-.177-.449-.358-.594-.182-.146-.403-.218-.663-.218-.359 0-.65.129-.874.386-.223.258-.335.675-.335 1.252 0 .613.11 1.049.331 1.308.22.26.506.39.858.39.26 0 .484-.082.671-.248.187-.165.322-.425.403-.779zm3.023 1.78l-1.731-4.842h1.06l1.226 3.584 1.186-3.584h1.037l-1.734 4.842h-1.044z" />
        </svg>
    </a>

    <a style="color: #734f96" href="https://www.linkedin.com/in/zev-averbach-964572156/">
        <svg style="fill: #734f96" class="about-icon" xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink" id="body_1" width="28" height="24">
            <title>LinkedIn</title>
            <g transform="matrix(0.044094488 0 0 0.044094488 -0 0.18897599)">
                <g transform="matrix(0.1 0 -0 -0.1 0 540)">
                    <path class="about-icon-fill"
                        d="M278 5376C 173 5338 77 5249 38 5152L38 5152L15 5095L15 2720L15 345L38 288C 69 212 143 132 222 89L222 89L285 55L2685 55L5085 55L5147 89C 5224 130 5293 202 5328 278L5328 278L5355 335L5355 2720L5355 5105L5328 5162C 5293 5238 5219 5315 5145 5354L5145 5354L5085 5385L2700 5387C 755 5389 308 5387 278 5376zM1329 4641C 1413 4615 1466 4582 1531 4513C 1594 4447 1620 4402 1645 4316C 1668 4239 1661 4117 1631 4038C 1535 3789 1244 3670 1007 3783C 713 3922 649 4304 881 4530C 1000 4645 1176 4689 1329 4641zM3867 3434C 3912 3426 3987 3406 4034 3389C 4319 3286 4471 3073 4543 2675C 4565 2558 4565 2536 4565 1695L4565 1695L4565 835L4170 835L3775 835L3769 1615C 3764 2325 3762 2400 3746 2455C 3718 2548 3680 2617 3633 2661C 3568 2721 3512 2742 3398 2748C 3175 2759 3038 2690 2960 2525C 2896 2388 2896 2390 2890 1575L2890 1575L2885 835L2490 835L2095 835L2092 2113L2090 3390L2475 3390L2860 3390L2860 3213L2860 3035L2887 3075C 3022 3277 3244 3417 3477 3449C 3561 3461 3757 3453 3867 3434zM1598 2113L1595 835L1200 835L805 835L802 2113L800 3390L1200 3390L1600 3390L1598 2113z"
                        stroke="none" fill-rule="nonzero" />
                    <path class="about-icon-negative"
                        d="M5813 695C 5770 674 5726 642 5704 617C 5558 450 5590 192 5770 71C 5843 23 5910 6 6005 12C 6277 30 6428 339 6279 572C 6242 629 6205 662 6136 697C 6093 720 6069 725 5985 728C 5886 732 5884 731 5813 695zM6103 667C 6177 633 6234 579 6267 512C 6291 464 6295 442 6295 375C 6295 309 6290 285 6268 238C 6151 -12 5802 -14 5680 235C 5646 303 5645 432 5676 501C 5753 667 5942 741 6103 667z"
                        stroke="none" fill-rule="nonzero" />
                    <path class="about-icon-fill"
                        d="M5850 370L5850 180L5875 180C 5900 180 5900 181 5900 265L5900 265L5900 350L5934 350C 5965 350 5971 344 6021 265C 6068 191 6078 180 6103 180C 6135 180 6137 174 6069 277L6069 277L6021 348L6048 355C 6113 371 6144 438 6116 503C 6096 551 6071 560 5949 560L5949 560L5850 560L5850 370zM6052 503C 6062 494 6070 473 6070 454C 6070 407 6041 390 5963 390L5963 390L5900 390L5900 455L5900 520L5967 520C 6015 520 6039 515 6052 503z"
                        stroke="none" fill-rule="nonzero" />
                </g>
            </g>
        </svg>
    </a>

    <a style="color: #734f96" href="https://github.com/zevaverbach">
        <svg style="fill: #734f96" class="about-icon" width="24" height="24" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <title>GitHub</title>
            <path class="about-icon-fill"
                d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" />
        </svg>
    </a>
</div>
</div> </div><!-- #body -->
              <script>
    let upButtonIsBackButton = true;
    const upButton = document.getElementById("up-button");
    function handleUpButtonClick() {
        if (upButtonIsBackButton) {
            window.location.href = "/posts.html";
        } else {
            document.documentElement.scrollTo({top: 0, behavior: 'smooth'});
        }
    }
    document.addEventListener("scroll", handleScroll);
    function handleScroll() {
        const {scrollTop, clientHeight} = document.documentElement;
        if (scrollTop === 0) {
            upButtonIsBackButton = true;
            upButton.style.transform = `rotate(-90deg)`;
        } else {
            upButtonIsBackButton = false;
            if (scrollTop <= clientHeight) {
                upButton.style.transform = `rotate(${(-Math.abs(scrollTop - clientHeight) / clientHeight) * 90}deg)`;
            } else {
                upButton.style.transform = `rotate(0deg)`;
            }
        }
    }
    document.addEventListener("DOMContentLoaded", event => {
        let imgs = document.getElementsByTagName('img');

        for (let i = 0; i < imgs.length; i++) {
            let img = imgs[i];
            img.title = img.alt;
        }

        const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");

        // Set a class on the html element
        if (prefersDarkScheme.matches) {
            console.log('set data-theme to dark');
            document.documentElement.setAttribute('data-theme', 'dark');
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
            console.log('set data-theme to light');
        }

        // Listener to switch themes when system settings are changed
        prefersDarkScheme.addListener((e) => {
            if (e.matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
                console.log('set data-theme to dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                console.log('set data-theme to light');
            }
        });
    })
</script>
              <script src="/static/prism-dark.js"></script>
</body>

</html>